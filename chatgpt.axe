{
  "manifest": {
    "id": "chatgpt",
    "name": "ChatGPT",
    "type": "meta-service",
    "version": "2.0.0",
    "author": "Parachord Team",
    "description": "Generate playlists and chat with AI DJ using ChatGPT. Requires OpenAI API key.",
    "icon": "ðŸ¤–",
    "color": "#10a37f",
    "homepage": "https://platform.openai.com"
  },
  "capabilities": {
    "generate": true,
    "chat": true
  },
  "settings": {
    "requiresAuth": true,
    "authType": "apikey",
    "configurable": {
      "apiKey": {
        "type": "password",
        "label": "API Key",
        "description": "Your OpenAI API key from platform.openai.com"
      },
      "model": {
        "type": "select",
        "label": "Model",
        "default": "gpt-4o-mini",
        "options": [
          { "value": "gpt-4o-mini", "label": "GPT-4o Mini (Fast, Recommended)" },
          { "value": "gpt-4o", "label": "GPT-4o (Most Capable)" },
          { "value": "gpt-4-turbo", "label": "GPT-4 Turbo" },
          { "value": "gpt-3.5-turbo", "label": "GPT-3.5 Turbo (Fastest)" }
        ]
      }
    }
  },
  "implementation": {
    "generate": "async function(prompt, config, listeningContext) {\n  const apiKey = config.apiKey;\n  if (!apiKey) throw new Error('OpenAI API key not configured');\n\n  const model = config.model || 'gpt-4o-mini';\n\n  let systemPrompt = 'You are a music expert. Generate a playlist based on the user\\'s request. Return ONLY a JSON array of objects with \"title\" and \"artist\" fields. No explanations, just the JSON array. Example: [{\"title\": \"Song Name\", \"artist\": \"Artist Name\"}]';\n\n  if (listeningContext) {\n    systemPrompt += '\\n\\nUser\\'s listening history for context:\\n' + JSON.stringify(listeningContext);\n  }\n\n  const response = await fetch('https://api.openai.com/v1/chat/completions', {\n    method: 'POST',\n    headers: {\n      'Content-Type': 'application/json',\n      'Authorization': `Bearer ${apiKey}`\n    },\n    body: JSON.stringify({\n      model: model,\n      messages: [\n        { role: 'system', content: systemPrompt },\n        { role: 'user', content: prompt }\n      ],\n      temperature: 0.7\n    })\n  });\n\n  if (!response.ok) {\n    const error = await response.json().catch(() => ({}));\n    throw new Error(error.error?.message || `OpenAI API error: ${response.status}`);\n  }\n\n  const data = await response.json();\n  const content = data.choices[0]?.message?.content || '[]';\n\n  try {\n    const jsonMatch = content.match(/\\[\\s*\\{[\\s\\S]*\\}\\s*\\]/);\n    if (jsonMatch) {\n      return JSON.parse(jsonMatch[0]);\n    }\n    return JSON.parse(content);\n  } catch (e) {\n    console.error('Failed to parse ChatGPT response:', content);\n    throw new Error('Could not parse playlist from response');\n  }\n}",
    "chat": "async function(messages, tools, config) {\n  const apiKey = config.apiKey;\n  if (!apiKey) throw new Error('OpenAI API key not configured');\n\n  const model = config.model || 'gpt-4o-mini';\n\n  const openaiTools = tools ? tools.map(tool => ({\n    type: 'function',\n    function: {\n      name: tool.name,\n      description: tool.description,\n      parameters: tool.parameters\n    }\n  })) : undefined;\n\n  // Convert messages to OpenAI format\n  // Tool calls need type: 'function' and stringified arguments\n  const openaiMessages = messages.map(msg => {\n    if (msg.role === 'assistant' && msg.tool_calls && msg.tool_calls.length > 0) {\n      return {\n        role: 'assistant',\n        content: msg.content || null,\n        tool_calls: msg.tool_calls.map(tc => ({\n          id: tc.id,\n          type: 'function',\n          function: {\n            name: tc.name,\n            arguments: typeof tc.arguments === 'string' ? tc.arguments : JSON.stringify(tc.arguments)\n          }\n        }))\n      };\n    }\n    return msg;\n  });\n\n  const response = await fetch('https://api.openai.com/v1/chat/completions', {\n    method: 'POST',\n    headers: {\n      'Content-Type': 'application/json',\n      'Authorization': `Bearer ${apiKey}`\n    },\n    body: JSON.stringify({\n      model: model,\n      messages: openaiMessages,\n      tools: openaiTools,\n      tool_choice: openaiTools ? 'auto' : undefined,\n      temperature: 0.7\n    })\n  });\n\n  if (!response.ok) {\n    const error = await response.json().catch(() => ({}));\n    throw new Error(error.error?.message || `OpenAI API error: ${response.status}`);\n  }\n\n  const data = await response.json();\n  const choice = data.choices[0];\n  const message = choice.message;\n\n  const result = {\n    content: message.content || '',\n    toolCalls: null\n  };\n\n  if (message.tool_calls && message.tool_calls.length > 0) {\n    result.toolCalls = message.tool_calls.map(tc => ({\n      id: tc.id,\n      name: tc.function.name,\n      arguments: JSON.parse(tc.function.arguments)\n    }));\n  }\n\n  return result;\n}"
  }
}
